/**
 * Gridzy v1.1
 *
 * Copyright 2015, Helmut Wandl
 */

var Gridzy=function(){"use strict";function e(e,n){var i="undefined"==typeof e.gridzy,o=i?this:e.gridzy,r=0;return e.gridzy=o,o._resetOptionParameters(),i?(o._updateOptionParameters(n),o._allItems=[],o._validItems=[],o._validItemsOptWidthAll=0,o._validItemsOptionDesiredElementHeight=null,o._validItemsOptionHideBoxOnMissingImage=null,o._container=document.createElement("div"),o._container.className="gridzyContainer",o._container.style.position="relative",o._container.style.padding="0",o._container.style.border="0",o._container.style.margin="0",o._container.style.display="block",t.prependChild(e,o._container),o.append(e.children),r=o._container.clientWidth,t.addEventListener(window,"resize",function(){o._container.clientWidth!==r&&(r=o._container.clientWidth,o.render())})):o.setOptions(n),o}var t={expectArray:function(e){return t.isArraylike(e)?e:[e]},isArraylike:function(e){return e.length===+e.length&&"string"!=typeof e},forceArrayObject:function(e){if(!e)return[];if("toArray"in Object(e))return e.toArray();for(var t=e.length||0,n=new Array(t);t--;)n[t]=e[t];return n},eachOfArray:function(e,t,n){var i;for(i=0;i<e.length;i++)n?t.apply(n,[e[i],i]):t(e[i],i)},domWalk:function(e,n){for(n(e),e=e.firstChild;e;)t.domWalk(e,n),e=e.nextSibling},prependChild:function(e,t){e.firstChild?e.insertBefore(t,e.firstChild):e.appendChild(t)},indexOfArray:Array.prototype.indexOf?function(e,t){return e.indexOf(t)}:function(e,t){for(var n=0,i=e.length;i>n;n++)if(n in e&&e[n]===t)return n;return-1},inArray:function(e,n){return-1!==t.indexOfArray(e,n)},addEventListener:document.addEventListener?function(e,t,n){e.addEventListener(t,n,!1)}:function(e,t,n){e.attachEvent("on"+t,function(t){n.apply(e,[t])})},addClass:document.createElement("div").classList?function(e,t){e.classList.add(t)}:function(e,t){e.className&&-1<e.className.search(new RegExp("(^|\\s+)"+t+"($|\\s+)"))||(e.className=(e.className+" "+t).replace(/\s+/," ").replace(/(^\s+|\s+$)/,""))},removeClass:document.createElement("div").classList?function(e,t){e.classList.remove(t)}:function(e,t){e.className=e.className.replace(new RegExp("(^|\\s+)"+t+"($|\\s+)")," ").replace(/\s+/," ").replace(/(^\s+|\s+$)/,"")},expectNaturalImageSize:function(){var e,n,i=[];return n=function(){var t;for(t=0;t<i.length;t++)i[t].imgB.width&&i[t].imgB.height&&(void 0===i[t].img.naturalWidth&&(i[t].img.naturalWidth=i[t].imgB.width),void 0===i[t].img.naturalHeight&&(i[t].img.naturalHeight=i[t].imgB.height)),(i[t].img.naturalWidth&&i[t].img.naturalHeight||i[t].ready)&&(i[t].callback(i[t].img,!i[t].error),i.splice(t,1),t--);i.length||(clearInterval(e),e=null)},function(o,r){var s={img:o,callback:r||function(){},imgB:document.createElement("img"),ready:!1,error:!1};t.addEventListener(s.imgB,"load",function(){s.ready=!0}),t.addEventListener(s.imgB,"error",function(){s.ready=!0,s.error=!0}),s.imgB.src=s.img.src,i.push(s),e||(e=setInterval(n,0))}}()};return e.prototype={setOptions:function(e){var t=this;t._updateOptionParameters(e),t.render()},getOption:function(e){var t=this,n=null;switch(typeof t._options[e]){case"function":n=t._options[e](t);break;default:n=t._options[e]}return n},render:function(){var e,t,n,i=this,o=i._calculateGrid(),r=o.rows.length,s=i.getOption("autoFontSize");for(i._options.onBeforeRender(i);r--;)for(e=o.rows[r],n=e.items.length;n--;)t=e.items[n],t.element.style.cssText="position: absolute; width: "+t.displaySizeX+"px; height: "+e.displaySizeY+"px; left: "+t.displayPosX+"px; top: "+e.displayPosY+"px; font-size: "+(s?100*t.displaySizeX/t.size[0]+"%":"100%")+"; ";i._container.style.height=o.size[1]+"px",i._options.onRender(i)},append:function(e){var n,i,o=this,r=0,s=1,a=2,l=3;i={maxQueueTime:1e3,maxQuietTime:400,queue:[],count:0,lastAdd:(new Date).getTime(),lastProcess:(new Date).getTime(),timer:null,add:function(e,t){i.queue.push({contentElement:e,item:t}),i.process(!1),i.lastAdd=(new Date).getTime()},process:function(n){var r,s=i.lastProcess<(new Date).getTime()-i.maxQueueTime,a=e.length===i.count+i.queue.length;if(null!==i.timer&&(clearTimeout(i.timer),i.timer=null),n||s||a){for(;r=i.queue.shift();)t.prependChild(r.item.element,r.contentElement),r.item.size=[r.contentElement.offsetWidth,r.contentElement.offsetHeight],r.item.ratio=r.item.size[0]/r.item.size[1],t.addClass(r.contentElement,"gridzyItemContent"),r.contentElement.style.width="100%",r.contentElement.style.height="100%",r.item.element.style.visibility="",r.item.contentElement.style.visibility="",i.count++;o._precalculateValues(),o.render(),i.lastProcess=(new Date).getTime()}else i.timer=setTimeout(function(){i.process(!0)},i.maxQuietTime)}},e=t.forceArrayObject(t.expectArray(e)),n=t.indexOfArray(e,o._container),n>-1&&e.splice(n,1),t.eachOfArray(e,function(e){var n,d,c,p=[],u=[];e.style.display="block",e.style.visibility="hidden",c=function(){t.inArray(u,s)||t.inArray(u,a)||(t.inArray(u,r)&&(n.failures=!0),t.removeClass(n.element,"gridzyItemLoading"),n.progressIndicator&&n.progressIndicator.parentNode&&(n.element.removeChild(n.progressIndicator),delete n.progressIndicator))},d=function(){t.inArray(u,r)&&(n.failures=!0),t.inArray(u,s)||i.add(e,n)},n={progressIndicator:document.createElement("span"),element:document.createElement("span"),contentElement:e,size:[0,0],ratio:0,failures:!1},t.addClass(n.progressIndicator,"gridzyItemProgressIndicator"),t.addClass(n.element,"gridzyItem"),t.addClass(n.element,"gridzyItemLoading"),n.element.appendChild(n.progressIndicator),n.element.style.position="absolute",n.element.style.visibility="hidden",t.domWalk(e,function(e){"IMG"===e.nodeName&&(p.push(e),u.push(s))}),t.eachOfArray(p,function(e,n){t.expectNaturalImageSize(e,function(i,o){var s=function(){u[n]=o&&u[n]&&i.naturalWidth?l:r,c()};u[n]=o&&i.naturalWidth?a:r,d(),t.addEventListener(e,"load",s),t.addEventListener(e,"error",function(){u[n]=r,c()}),e.complete&&s()})}),o._allItems.push(n),o._container.appendChild(n.element),d(),c()}),o.render()},_resetOptionParameters:function(){this._options={spaceBetweenElements:1,desiredElementHeight:200,autoFontSize:!1,hideBoxOnMissingImage:!0,onBeforeOptionsChanged:function(){},onOptionsChanged:function(){},onBeforeRender:function(){},onRender:function(){}}},_updateOptionParameters:function(e){var t=this;e=e||{},t._options.onBeforeOptionsChanged(t),"undefined"!=typeof e.spaceBetweenElements&&(t._options.spaceBetweenElements="function"==typeof e.spaceBetweenElements?e.spaceBetweenElements:+e.spaceBetweenElements),"undefined"!=typeof e.desiredElementHeight&&(t._options.desiredElementHeight="function"==typeof e.desiredElementHeight?e.desiredElementHeight:+e.desiredElementHeight),"undefined"!=typeof e.autoFontSize&&(t._options.autoFontSize="function"==typeof e.autoFontSize?e.autoFontSize:!!e.autoFontSize),"undefined"!=typeof e.hideBoxOnMissingImage&&(t._options.hideBoxOnMissingImage="function"==typeof e.hideBoxOnMissingImage?e.hideBoxOnMissingImage:!!e.hideBoxOnMissingImage),"function"==typeof e.onBeforeOptionsChanged&&(t._options.onBeforeOptionsChanged=e.onBeforeOptionsChanged),"function"==typeof e.onOptionsChanged&&(t._options.onOptionsChanged=e.onOptionsChanged),"function"==typeof e.onBeforeRender&&(t._options.onBeforeRender=e.onBeforeRender),"function"==typeof e.onRender&&(t._options.onRender=e.onRender),t._options.onOptionsChanged(t)},_precalculateValues:function(e){var t,n=this,i=n._allItems,o=[],r=0,s=i.length,a=n.getOption("desiredElementHeight"),l=n.getOption("hideBoxOnMissingImage");if(!e||n._validItemsOptionDesiredElementHeight!==a||n._validItemsOptionHideBoxOnMissingImage!==l){for(;s--;)t=i[s],l&&t.failures?t.element.style.display="none":t.size[0]&&t.size[1]&&(t.element.style.display="",o.unshift(t),t.optWidth=a*t.size[0]/t.size[1],r+=t.optWidth);n._validItemsOptionDesiredElementHeight=a,n._validItemsOptionHideBoxOnMissingImage=l,n._validItems=o,n._validItemsOptWidthAll=r}},_calculateGrid:function(){var e,t,n,i,o,r,s,a,l,d,c,p,u=this,m=u.getOption("spaceBetweenElements"),f=u._container.clientWidth,h=0,g={rows:[],size:[f,0]},y=g.rows,v=0,_=0;for(this._precalculateValues(!0),n=u._validItems,i=n.length,r=u._validItemsOptWidthAll,s=r/(Math.round((r+m*i)/(f+m))||1),e=i;e--;)o=n[e],h+o.optWidth/2>s*y.length&&y.unshift({displaySizeY:0,displayPosY:0,ratioAll:0,items:[]}),h+=o.optWidth,y[0].ratioAll+=o.ratio,y[0].items.unshift(o);for(a=y.length,c=null,e=0;a>e;e++){for(l=y[e],v=0,_=0,d=l.items.length,p=f-(d-1)*m,t=0;d>t;t++)o=l.items[t],o.displaySizeX=Math.round(o.ratio/l.ratioAll*p),o.displayPosX=v+t*m,v+=o.displaySizeX,t===d-1&&v!==p&&(o.displaySizeX+=p-v),_+=o.displaySizeX/o.ratio;l.displaySizeY=Math.round(_/d),l.displayPosY=c?c.displayPosY+c.displaySizeY+m:0,g.size[1]+=l.displaySizeY+(e?m:0),c=l}return g}},"undefined"!=typeof jQuery&&"undefined"!=typeof jQuery.fn&&(jQuery.fn.gridzy=function(t){return this.each(function(){jQuery(this).data("gridzy",new e(this,t))})}),e}();